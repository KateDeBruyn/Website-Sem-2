<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatiable" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Description goes here" />
    <meta name="author" content="Keighty Rose, Kate de Bruyn" />
    <meta name="keywords" content="game design, developer, streamer, blog" />
    <title>Visualisations by KeightyRose</title>
    <link rel="stylesheet" href="normalise.css" />
    <link rel="stylesheet" href="stylesheet.css" />
    <script
      src="https://kit.fontawesome.com/a7ac100429.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="javascript.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
  </head>

  <body>
    <header>
      <nav>
        <input type="checkbox" id="check" />
        <label for="check" class="menu-bars"
          ><i class="fa-solid fa-bars"></i
        ></label>
        <label for="logo" id="logo">keightyrose</label>
        <ul>
          <li><a id="nav-button" href="index.html">Home</a></li>
          <li><a id="nav-button" href="blog.html">Blog</a></li>
          <li>
            <a id="nav-button-data" href="datavisualisation.html">Data V</a>
          </li>
          <li><a id="nav-button" href="dataart.html">Data Art</a></li>
          <li>
            <a id="nav-button" href="styleguide.html">Style Guide</a>
          </li>
        </ul>
      </nav>
    </header>
    <main>
      <div class="datav-container">
        <div class="index-item-light">
          <div id="my_dataviz">
            <script>
              function convertJsonToCSV(jsonData) {
                const header = ["title", "salePrice", "normalPrice"];
                const headerString = header.join(",");

                const replacer = (key, value) => value ?? "";

                const rowItems = jsonData.map((row) =>
                  header.map((fieldName) => row[fieldName]).join(",")
                );
                // If values must be strings, use this
                //.map((fieldName) => JSON.stringify(row[fieldName], replacer))

                // join header and body, and break into separate lines
                const csv = [headerString, ...rowItems].join("\r\n");

                return csv;
              }

              async function getData() {
                const api_url =
                  "https://www.cheapshark.com/api/1.0/deals?storeID=1&upperPrice=15";
                // Raw data
                const api_data = await fetch(api_url);

                // Converts raw data to json
                const api_json = await api_data.json();

                // const dataG1 = api_json.slice(0, 4);

                // Created a list of IDs for games that will be displayed
                const gameIds = ["166", "160047", "247672", "168082"];

                // dataG1 is the filtered list
                const dataG1 = api_json.filter(function (game) {
                  // Returns a list of games that match our list of IDs
                  if (gameIds.includes(game.gameID)) {
                    return game;
                  }
                });

                var csvData = convertJsonToCSV(dataG1);

                // set the dimensions and margins of the graph
                var margin = { top: 10, right: 30, bottom: 20, left: 50 },
                  width = 460 - margin.left - margin.right,
                  height = 400 - margin.top - margin.bottom;

                // append the svg object to the body of the page
                var svg = d3
                  .select("#my_dataviz")
                  .append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                  .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                  );

                // Using manually created CSV
                //d3.csv((href = "jsontocsv.csv"), function (data)

                // Using data converted to CSV
                //d3.csvParse(csvData, function (data)

                console.log(csvData);

                // Parse the Data
                parsData(csvData);

                d3.csv((href = "jsontocsv.csv"), function (data) {
                  console.log(data);
                  // List of subgroups = header of the csv files = soil condition here
                  var subgroups = data.columns.slice(1);

                  // List of groups = species here = value of the first column called group -> I show them on the X axis
                  var groups = d3
                    .map(data, function (d) {
                      return d.title;
                    })
                    .keys();

                  // Add X axis
                  var x = d3
                    .scaleBand()
                    .domain(groups)
                    .range([0, width])
                    .padding([0.2]);
                  svg
                    .append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).tickSize(0));

                  // Add Y axis
                  var y = d3.scaleLinear().domain([0, 40]).range([height, 0]);
                  svg.append("g").call(d3.axisLeft(y));

                  // Another scale for subgroup position?
                  var xSubgroup = d3
                    .scaleBand()
                    .domain(subgroups)
                    .range([0, x.bandwidth()])
                    .padding([0.05]);

                  // color palette = one color per subgroup
                  var color = d3
                    .scaleOrdinal()
                    .domain(subgroups)
                    .range(["#e41a1c", "#377eb8", "#4daf4a"]);

                  // Show the bars
                  svg
                    .append("g")
                    .selectAll("g")
                    // Enter in data = loop group per group
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("transform", function (d) {
                      return "translate(" + x(d.title) + ",0)";
                    })
                    .selectAll("rect")
                    .data(function (d) {
                      return subgroups.map(function (key) {
                        return { key: key, value: d[key] };
                      });
                    })
                    .enter()
                    .append("rect")
                    .attr("x", function (d) {
                      return xSubgroup(d.key);
                    })
                    .attr("y", function (d) {
                      return y(d.value);
                    })
                    .attr("width", xSubgroup.bandwidth())
                    .attr("height", function (d) {
                      return height - y(d.value);
                    })
                    .attr("fill", function (d) {
                      return color(d.key);
                    });
                });
              }

              // Ideal option: function parsData(data)

              function parsData(data) {
                console.log(data);
                // List of subgroups = header of the csv files = soil condition here
                var subgroups = data.columns.slice(1);

                // List of groups = species here = value of the first column called group -> I show them on the X axis
                var groups = d3
                  .map(data, function (d) {
                    return d.title;
                  })
                  .keys();

                // Add X axis
                var x = d3
                  .scaleBand()
                  .domain(groups)
                  .range([0, width])
                  .padding([0.2]);
                svg
                  .append("g")
                  .attr("transform", "translate(0," + height + ")")
                  .call(d3.axisBottom(x).tickSize(0));

                // Add Y axis
                var y = d3.scaleLinear().domain([0, 40]).range([height, 0]);
                svg.append("g").call(d3.axisLeft(y));

                // Another scale for subgroup position?
                var xSubgroup = d3
                  .scaleBand()
                  .domain(subgroups)
                  .range([0, x.bandwidth()])
                  .padding([0.05]);

                // color palette = one color per subgroup
                var color = d3
                  .scaleOrdinal()
                  .domain(subgroups)
                  .range(["#e41a1c", "#377eb8", "#4daf4a"]);

                // Show the bars
                svg
                  .append("g")
                  .selectAll("g")
                  // Enter in data = loop group per group
                  .data(data)
                  .enter()
                  .append("g")
                  .attr("transform", function (d) {
                    return "translate(" + x(d.title) + ",0)";
                  })
                  .selectAll("rect")
                  .data(function (d) {
                    return subgroups.map(function (key) {
                      return { key: key, value: d[key] };
                    });
                  })
                  .enter()
                  .append("rect")
                  .attr("x", function (d) {
                    return xSubgroup(d.key);
                  })
                  .attr("y", function (d) {
                    return y(d.value);
                  })
                  .attr("width", xSubgroup.bandwidth())
                  .attr("height", function (d) {
                    return height - y(d.value);
                  })
                  .attr("fill", function (d) {
                    return color(d.key);
                  });
              }

              getData();
            </script>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
